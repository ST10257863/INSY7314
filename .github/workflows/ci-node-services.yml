# CI - Node + Postgres service
# - Starts a postgres service on the Actions runner
# - Installs server+client deps, starts server in background, waits for health, builds client, runs a basic smoke test
name: CI - Node + Postgres service

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:13
        env:
          POSTGRES_DB: secure_payments
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
        ports:
          - 5432:5432
        options: >-
          --health-cmd "pg_isready -U postgres -d secure_payments"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    env:
      DATABASE_URL: postgres://postgres:postgres@localhost:5432/secure_payments
      NODE_ENV: test
      CORS_ORIGIN: http://localhost:5173

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install server dependencies
        working-directory: server
        run: npm ci

      - name: Install client dependencies
        working-directory: client
        run: npm ci

      - name: Prepare server .env (CI overrides)
        working-directory: server
        env:
          DATABASE_URL: ${{ env.DATABASE_URL }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
          SESSION_SECRET: ${{ secrets.SESSION_SECRET }}
        run: |
          cp .env.example .env || true
          echo "DATABASE_URL=$DATABASE_URL" >> .env
          [ -n "$JWT_SECRET" ] && echo "JWT_SECRET=$JWT_SECRET" >> .env
          [ -n "$SESSION_SECRET" ] && echo "SESSION_SECRET=$SESSION_SECRET" >> .env

      - name: Run DB migrations (optional)
        working-directory: server
        run: |
          npm run migrate || echo "no migrate script or migrations not required"

      - name: Start server in background
        working-directory: server
        run: |
          npm run start &
          sleep 1

      - name: Wait for server to be ready
        run: npx wait-on http://localhost:8443/api/health || (sleep 3 && npx wait-on http://localhost:8443/api/health)

      - name: Client build
        working-directory: client
        env:
          VITE_API_URL: http://localhost:8443
        run: npm run build

      - name: Basic API smoke test
        run: |
          curl -f http://localhost:8443/api/health || (echo "server did not respond on /api/health" && exit 1)

      - name: Tear down (no-op; runner will clean up)
        if: always()
        run: echo "job complete"
